---
apiVersion: v1
kind: ConfigMap
metadata:
  name: arr-config-init-script
  namespace: media
  labels:
    app.kubernetes.io/part-of: media-server
data:
  init-config.sh: |
    #!/bin/sh
    set -e

    APP_NAME="$1"
    API_KEY="$2"
    APP_PORT="$3"
    CONFIG_FILE="/config/config.xml"

    echo "Initializing ${APP_NAME} configuration..."

    # Only create config if it doesn't exist
    if [ -f "$CONFIG_FILE" ]; then
      echo "Config file already exists at $CONFIG_FILE, skipping initialization"
      exit 0
    fi

    echo "Creating initial config.xml with API key..."

    cat > "$CONFIG_FILE" <<EOF
    <Config>
      <LogLevel>info</LogLevel>
      <UpdateMechanism>Docker</UpdateMechanism>
      <Branch>main</Branch>
      <BindAddress>*</BindAddress>
      <Port>${APP_PORT}</Port>
      <SslPort>0</SslPort>
      <EnableSsl>False</EnableSsl>
      <LaunchBrowser>False</LaunchBrowser>
      <ApiKey>${API_KEY}</ApiKey>
      <AuthenticationMethod>None</AuthenticationMethod>
      <AnalyticsEnabled>False</AnalyticsEnabled>
      <UrlBase></UrlBase>
    </Config>
    EOF

    echo "Initial config created successfully for ${APP_NAME}"
    echo "API Key: ${API_KEY}"
